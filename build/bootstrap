#!/bin/bash
set -e

# Check if we're in a read-only filesystem (SAM or Lambda)
TASK_ROOT=${LAMBDA_TASK_ROOT:-/var/task}
if [ -w ${TASK_ROOT} ]; then
  chmod 755 ${TASK_ROOT}/deno
fi

# Set environment variables
export DENO_DIR=/tmp/deno_dir
export PATH=${TASK_ROOT}:$PATH

# For SAM local testing, Lambda runtime API is at host.docker.internal:3001
# In Lambda, AWS sets this environment variable
if [ -z "${AWS_LAMBDA_RUNTIME_API}" ]; then
  echo "No AWS_LAMBDA_RUNTIME_API found, assuming SAM local environment"
  export AWS_LAMBDA_RUNTIME_API="host.docker.internal:3001"
fi

# Execute the handler
exec ${TASK_ROOT}/deno run \
  --allow-env \
  --allow-net \
  --allow-read \
  --allow-write=/tmp \
  --no-check \
  ${TASK_ROOT}/direct-handler.js
